name: Build & Test (Windows & Linux)
run-name: ${{ github.actor }} has run the build & test workflow

on:
  pull_request:
    branches: [main]
    paths:
      - "server/**"
      - "client/**"
      - "common/**"
      - "CMakeLists.txt"
      - "vcpkg.json"

jobs:
  check_repository:
    name: Check the repository
    runs-on: ubuntu-latest
    outputs:
      target: ${{ steps.new.outputs.value }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if we are in the mirrored repository
        id: new
        run: |
          if [[ "${{ github.repository }}" == *"Epitech"* ]]; then
            echo "::notice::You are in the Epitech repository"
            echo "value=1" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "value=0" >> "$GITHUB_OUTPUT"
          exit 0

  build-linux:
    needs: check_repository
    if: ${{ needs.check_repository.outputs.target == 0 }}
    name: Ubuntu - Release
    runs-on: ubuntu-latest

    container:
      image: epitechcontent/epitest-docker:latest
      options: --user root

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_TRIPLET: x64-linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install Linux Dependencies
        run: |
          apt-get update
          apt-get install -y \
            libx11-dev libxrandr-dev libxcursor-dev libxi-dev libudev-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libflac-dev libogg-dev libvorbis-dev libopenal-dev \
            libfreetype6-dev

      - name: Get CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgJsonGlob: "vcpkg.json"
          runVcpkgInstall: true

      - name: Run CMake with Presets
        uses: lukka/run-cmake@v10
        with:
          cmakeListsTxtPath: "${{ github.workspace }}/CMakeLists.txt"
          configurePreset: "ci-release"
          buildPreset: "ci-release-build"

      # - name: Run Tests
      #   uses: lukka/run-cmake@v10
      #   with:
      #     testPreset: 'ci-tests'

  build-windows:
    needs: check_repository
    if: ${{ needs.check_repository.outputs.target == 0 }}
    name: Windows - Release
    runs-on: windows-latest

    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_TRIPLET: x64-windows

    steps:
      - name: Support Long Paths (Windows)
        run: git config --system core.longpaths true

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: ${{ github.workspace }}/vcpkg
          vcpkgJsonGlob: "vcpkg.json"
          runVcpkgInstall: true

      - name: Run CMake with Presets
        uses: lukka/run-cmake@v10
        with:
          cmakeListsTxtPath: "${{ github.workspace }}/CMakeLists.txt"
          configurePreset: "ci-release"
          buildPreset: "ci-release-build"
