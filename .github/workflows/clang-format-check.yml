name: ClangFormat Check

on:
  push:
    branches: [ main, develop, "*" ]
  pull_request:
    branches: [ main, develop ]

jobs:
  format-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format
    
    - name: Check code formatting
      run: |
        echo "üîç Checking C++ code formatting with Google style..."
        
        # Find all .cpp and .hpp files
        FILES=$(find . -type f \( -name "*.cpp" -o -name "*.hpp" \) -not -path "./build/*" -not -path "./.git/*")
        
        EXIT_CODE=0
        FILE_COUNT=0
        ERROR_COUNT=0
        
        for file in $FILES; do
          FILE_COUNT=$((FILE_COUNT + 1))
          echo "Checking: $file"
          
          # Check if file needs formatting by comparing with formatted output
          if ! diff -q "$file" <(clang-format "$file") > /dev/null 2>&1; then
            echo "  ‚ùå $file has formatting issues"
            
            # Show diff
            diff -u "$file" <(clang-format "$file") || true
            
            ERROR_COUNT=$((ERROR_COUNT + 1))
            EXIT_CODE=1
          else
            echo "  ‚úì $file is properly formatted"
          fi
        done
        
        echo ""
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        echo "Files checked: $FILE_COUNT"
        
        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ All files are properly formatted!"
        else
          echo "‚ùå $ERROR_COUNT file(s) with formatting issues"
          echo ""
          echo "To fix, run locally:"
          echo "  make format-fix"
          echo "  git add ."
          echo "  git commit -m \"style: apply clang-format\""
          exit 1
        fi
        
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    
    - name: Formatting check summary
      if: failure()
      run: |
        echo "::error::Code formatting check failed. Please run 'make format-fix' locally and commit the changes."
